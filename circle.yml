test:
  override:
    # check build
    ## run build
    - cd jsk_android_apps; ./gradlew assemble || ./gradlew assembleDebug
    ## copy to artifacts
    - find -iname '*-release.apk' -print -exec cp {} $CIRCLE_ARTIFACTS \;
deployment:
  release:
    tag: /[0-9]+(\.[0-9]+)*/
    commands:
      - cd jsk_android_apps; ./gradlew publishApkRelease
      - git clone -b v2.2.2 https://github.com/github/hub.git;
      - cd hub; ./script/build; sudo cp hub /usr/local/bin/
      - mkdir -p ~/.config/
      - "echo \"github.com:\" > ~/.config/hub"
      - "echo \"- user: k-okada\" >> ~/.config/hub"
      - "echo \"  oauth_token: $GITHUB_ACCESS_TOKEN\" >> ~/.config/hub"
      - for apk in $CIRCLE_ARTIFACTS/*.apk ; do hub release create -p -a $apk -m "$CIRCLE_TAG"$'\n'"Released on `date '+%Y/%m/%d %H:%M:%S'`" $CIRCLE_TAG; done
      # publish
      ## restore key.json
      - echo $PASSWORD | gpg --batch --passphrase-fd 0 -o jsk_android_apps/key.json -d jsk_android_apps/key.json.gpg
      ## get all log build.gradle -> defaultConfig -> versionCode use this
      - git fetch --unshallow
      ## check publish
      - sed -i "s@include 'android_camera_viewer'@/*include 'android_camera_viewer'*/@" jsk_android_apps/settings.gradle # temporary disable android_camera_viewer
      - cd jsk_android_apps; ./gradlew publishApkRelease
      ## setting to production release is intentionally put here, to check for each build
      - sed "s@play {@play{\n\t\ttrack = 'production'@" jsk_android_apps/build.gradle
      - cd jsk_android_apps; ./gradlew publishApkRelease
      - cd jsk_android_apps; ./gradlew publishListingRelease
